From 504350b46a54d6845d11edf59e578a4711f2a36a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Kamil=20Trzci=C5=84ski?= <ayufan@ayufan.eu>
Date: Sun, 18 Oct 2020 21:37:42 +0200
Subject: [PATCH] ayufan: dts: rockpro64: add type-c DP ALT and USB3

---
 .../boot/dts/rockchip/rk3399-rockpro64.dtsi   | 105 +++++++++++++++++-
 1 file changed, 102 insertions(+), 3 deletions(-)

diff --git a/arch/arm64/boot/dts/rockchip/rk3399-rockpro64.dtsi b/arch/arm64/boot/dts/rockchip/rk3399-rockpro64.dtsi
index 094d474f8141e..874af7d3b6339 100644
--- a/arch/arm64/boot/dts/rockchip/rk3399-rockpro64.dtsi
+++ b/arch/arm64/boot/dts/rockchip/rk3399-rockpro64.dtsi
@@ -6,6 +6,7 @@
 
 #include <dt-bindings/input/linux-event-codes.h>
 #include <dt-bindings/pwm/pwm.h>
+#include <dt-bindings/usb/pd.h>
 #include "rk3399.dtsi"
 #include "rk3399-opp.dtsi"
 
@@ -158,9 +159,14 @@
 		gpio = <&gpio1 RK_PA3 GPIO_ACTIVE_HIGH>;
 		pinctrl-names = "default";
 		pinctrl-0 = <&vcc5v0_typec_en>;
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
 		regulator-name = "vcc5v0_typec";
-		regulator-always-on;
 		vin-supply = <&vcc5v0_usb>;
+
+		regulator-state-mem {
+			regulator-off-in-suspend;
+		};
 	};
 
 	vcc5v0_sys: vcc5v0-sys {
@@ -195,6 +201,11 @@
 	};
 };
 
+&cdn_dp {
+	status = "okay";
+	extcon = <&fusb0>;
+};
+
 &cpu_l0 {
 	cpu-supply = <&vdd_cpu_l>;
 };
@@ -503,12 +514,77 @@
 	fusb0: typec-portc@22 {
 		compatible = "fcs,fusb302";
 		reg = <0x22>;
-		interrupt-parent = <&gpio1>;
-		interrupts = <RK_PA2 IRQ_TYPE_LEVEL_LOW>;
+		fcs,int_n = <&gpio1 RK_PA2 GPIO_ACTIVE_HIGH>;
 		pinctrl-names = "default";
 		pinctrl-0 = <&fusb0_int>;
 		vbus-supply = <&vcc5v0_typec>;
 		status = "okay";
+
+		connector {
+			compatible = "usb-c-connector";
+			data-role = "host";
+			label = "USB-C";
+			op-sink-microwatt = <1000000>;
+			power-role = "dual";
+			sink-pdos =
+				<PDO_FIXED(5000, 2500, PDO_FIXED_USB_COMM)>;
+			source-pdos =
+				<PDO_FIXED(5000, 1400, PDO_FIXED_USB_COMM)>;
+			try-power-role = "sink";
+
+			// [  128.617910] typec_displayport port0-partner.0:
+			// No compatible pin configuration found:0000 -> 000c, 001c <- 0000
+			// No compatible pin configuration found:0000 -> 000c, 000c <- 0000
+			// No compatible pin configuration found:0000 -> 000c, 0000 <- 0000
+			// No compatible pin configuration found:0000 -> 000c, 0000 <- 0000
+			// No compatible pin configuration found:000c -> 0000, 0000 <- 000c
+
+			// root@rockpro64:/sys/devices/platform/ff3d0000.i2c/i2c-4/4-0022/typec/port0/port0-partner/port0-partner.0# cat svid 
+			// ff01
+			// root@rockpro64:/sys/devices/platform/ff3d0000.i2c/i2c-4/4-0022/typec/port0/port0-partner/port0-partner.0# cat vdo
+			// 0x00000c05
+			// root@rockpro64:/sys/devices/platform/ff3d0000.i2c/i2c-4/4-0022/typec/port0/port0-partner/port0-partner.0# cat mode
+			// 1
+			// root@rockpro64:/sys/devices/platform/ff3d0000.i2c/i2c-4/4-0022/typec/port0/port0-partner/port0-partner.0# cat active 
+			// yes
+
+			extcon-cables = <1 2 5 6 9 10 12 44>;
+			typec-altmodes = <
+				0xff01 1 0x001c0c00 1
+			>;
+
+			ports {
+				#address-cells = <1>;
+				#size-cells = <0>;
+
+				port@0 {
+					reg = <0>;
+
+					usbc_hs: endpoint {
+						remote-endpoint =
+							<&u2phy0_typec_hs>;
+					};
+				};
+
+				port@1 {
+					reg = <1>;
+
+					usbc_ss: endpoint {
+						remote-endpoint =
+							<&tcphy0_typec_ss>;
+					};
+				};
+
+				port@2 {
+					reg = <2>;
+
+					usbc_dp: endpoint {
+						remote-endpoint =
+							<&tcphy0_typec_dp>;
+					};
+				};
+			};
+		};
 	};
 };
 
@@ -735,9 +811,26 @@
 };
 
 &tcphy0 {
+	extcon = <&fusb0>;
 	status = "okay";
 };
 
+&tcphy0_dp {
+	port {
+		tcphy0_typec_dp: endpoint {
+			remote-endpoint = <&usbc_dp>;
+		};
+	};
+};
+
+&tcphy0_usb3 {
+	port {
+		tcphy0_typec_ss: endpoint {
+			remote-endpoint = <&usbc_ss>;
+		};
+	};
+};
+
 &tcphy1 {
 	status = "okay";
 };
@@ -761,6 +854,12 @@
 		phy-supply = <&vcc5v0_host>;
 		status = "okay";
 	};
+
+	port {
+		u2phy0_typec_hs: endpoint {
+			remote-endpoint = <&usbc_hs>;
+		};
+	};
 };
 
 &u2phy1 {
